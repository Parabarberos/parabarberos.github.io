<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRASLADOS ENTRE BODEGAS PARABARBEROS S.A.S.</title>
    <link rel="icon" type="image/jpeg" href="https://parabarberos.github.io/2.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-12 text-center">
            <div class="inline-block p-2 bg-white rounded-full shadow-lg mx-auto mb-6 border-4 border-gray-200">
                <img src="https://parabarberos.github.io/2.jpg" alt="Logo Parabarberos" class="h-24 w-24 md:h-32 md:w-32 rounded-full">
            </div>
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 tracking-tight">TRASLADOS ENTRE BODEGAS</h1>
            <div class="mt-8 flex justify-center items-center gap-4">
                <div>
                    <span class="text-gray-600">Usuario:</span>
                    <span id="userEmailDisplay" class="font-bold text-gray-800">Cargando...</span>
                </div>
                <button id="logoutBtn" class="bg-gray-200 hover:bg-red-200 text-red-700 font-semibold py-2 px-4 border border-red-300 rounded-lg shadow-sm">
                    Cerrar Sesión
                </button>
            </div>
        </header>

        <!-- VISTA DE SOLICITANTE -->
        <div id="requesterView" class="grid grid-cols-1 lg:grid-cols-3 gap-8" style="display: none;">
            <div class="lg:col-span-2 space-y-8">
                <!-- Tarjeta de Nueva Solicitud (sin cambios) -->
                <div class="bg-white p-6 rounded-xl shadow-lg card">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Nueva solicitud de traslado</h2>
                    <div class="mb-4"><input type="search" id="searchInput" placeholder="Buscar producto..." class="w-full px-4 py-2 border border-gray-300 rounded-lg"></div>
                    <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4 mb-6 min-h-[200px] max-h-[50vh] overflow-y-auto p-4 bg-gray-50 rounded-lg"></div>
                    <h3 class="text-xl font-semibold mb-3 text-gray-800"> Productos seleccionados</h3>
                    <div id="currentTransferRequest" class="space-y-3 mb-6 min-h-[100px] max-h-[40vh] overflow-y-auto p-4 bg-gray-50 rounded-lg"></div>
                    <form id="transferForm" class="space-y-4 border-t pt-6">
                        <h3 class="text-xl font-semibold mb-3 text-gray-800"> Detalles de traslado</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="toWarehouse" class="block text-sm font-medium text-gray-700">Bodega Destino:</label><select id="toWarehouse" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"></select></div>
                            <div><label for="requesterName" class="block text-sm font-medium text-gray-700">Solicitante:</label><select id="requesterName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm bg-gray-100" disabled></select></div>
                            <div><label for="deliveryDate" class="block text-sm font-medium text-gray-700">Fecha de solicitud</label><input type="date" id="deliveryDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"></div>
                        </div>
                        <input type="hidden" id="fromWarehouse" value="Bodega Principal">
                        <div><label for="requesterNotes" class="block text-sm font-medium text-gray-700">Observaciones</label><textarea id="requesterNotes" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Ej: Necesito este pedido con urgencia para un cliente..."></textarea></div>
                        <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg">ENVIAR SOLICITUD DE TRASLADO</button>
                    </form>
                </div>
            </div>
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg card">
                <h3 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Mis solicitudes</h3>
                
                <!-- **** INICIA LA NUEVA SECCIÓN **** -->
                <h4 class="text-xl font-bold text-red-600 mb-2">Por Recibir</h4>
                <div id="myShippedRequests" class="space-y-4 mb-6 border-b pb-6"></div>
                <!-- **** TERMINA LA NUEVA SECCIÓN **** -->

                <div class="space-y-2 mb-4">
                    <input type="text" id="requesterSearchId" placeholder="Buscar por ID..." class="w-full px-3 py-2 border rounded-lg">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" id="requesterDateFrom" class="w-full px-3 py-2 border rounded-lg text-sm" title="Fecha Desde">
                        <input type="date" id="requesterDateTo" class="w-full px-3 py-2 border rounded-lg text-sm" title="Fecha Hasta">
                    </div>
                </div>
                <div class="max-h-[80vh] overflow-y-auto">
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Activas</h4>
                    <div id="myPendingRequests" class="space-y-4 mb-6"></div>
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Historial</h4>
                    <div id="myHistoryRequests" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <!-- VISTA DE ADMINISTRADOR (sin cambios en su estructura HTML) -->
        <div id="adminView" class="grid grid-cols-1 lg:grid-cols-2 gap-8" style="display: none;">
            <!-- ... (Tu HTML de la vista de admin se queda igual) ... -->
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- 1. CONFIGURACIÓN E INICIALIZACIÓN ---
        const firebaseConfig = {
            apiKey: "AIzaSyBmmNg525KrnOTsebzAV9dzfsKiq3o-0iQ",
            authDomain: "base-de-datos-traslados.firebaseapp.com",
            projectId: "base-de-datos-traslados",
            storageBucket: "base-de-datos-traslados.appspot.com",
            messagingSenderId: "569583717634",
            appId: "1:569583717634:web:f7baa7aaf66a639624461b",
            measurementId: "G-9CSBCGJRGS"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const transfersCollection = db.collection("transferencias");
        const productsCollection = db.collection("products");

        // --- MAPEO DE USUARIOS Y ROLES ---
        const USER_ROLES = {
            'inventarios.parabarberos@gmail.com': ['Administrador', 'admin'],
            'parabarberossedecentro@gmail.com': ['Punto de venta Cali centro', 'requester'],
            'parabarberossedesur@gmail.com': ['Punto de venta Cali sur', 'requester'],
            'parabarberossedepasto@gmail.com': ['Punto de venta Pasto', 'requester'],
            'parabarberossedetulua@gmail.com': ['Punto de venta Tulua', 'requester'],
            'parabarberossedemedellin@gmail.com': ['Punto de venta Medellin', 'requester']
        };

        // --- 2. VARIABLES GLOBALES Y DE ESTADO ---
        let allProducts = [];
        let currentTransferItems = JSON.parse(localStorage.getItem('currentTransferDraft')) || [];
        let allTransferRequests = [];
        let currentUserData = null;

        // --- 3. REFERENCIAS AL DOM ---
        const dom = {
            // ... (Tu objeto DOM, añadiendo el nuevo div)
            myShippedRequests: document.getElementById('myShippedRequests'),
            // ... el resto de tus elementos
        };
        
        // --- NUEVOS ESTADOS Y COLORES ---
        const getRequestStatusColor = (s) => ({
            'pending':'border-l-4 border-gray-400 bg-gray-50',
            'processing_partial_items':'border-l-4 border-orange-500 bg-orange-50',
            'shipped': 'border-l-4 border-blue-500 bg-blue-50',
            'completed':'border-l-4 border-green-600 bg-green-50',
            'completed_incomplete':'border-l-4 border-yellow-500 bg-yellow-50',
            'cancelled':'border-l-4 border-red-700 bg-red-100'
        }[s] || 'border-l-4 border-gray-300');

        const translateStatus = (s) => ({
            'pending':'Pendiente',
            'processing_partial_items':'En Revisión',
            'shipped': 'Enviado (Pendiente de Recepción)',
            'completed':'Recibido Completo',
            'completed_incomplete':'Recibido Incompleto',
            'cancelled':'Cancelado'
        }[s] || s);

        // --- 4. LÓGICA DE AUTENTICACIÓN (sin cambios) ---
        auth.onAuthStateChanged(user => { /* ... tu código ... */ });
        dom.logoutBtn.onclick = () => auth.signOut();
        
        // --- 5. FUNCIONES ---
        
        function setupUIForUser() { /* ... tu código ... */ }
        function applyFilters(requests, searchInput, dateFromInput, dateToInput) { /* ... tu código ... */ }
        
        // FUNCIÓN MODIFICADA
        function renderAllSections() {
            if (!currentUserData) return;
            const { name, role } = currentUserData;
            const sortedRequests = allTransferRequests.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
            
            if (role === 'requester') {
                const allMyRequests = sortedRequests.filter(r => r.requesterName === name);
                
                renderSection(dom.myShippedRequests, allMyRequests.filter(r => r.status === 'shipped'), 'requester', "No tienes traslados por recibir.");
                const activeRequests = allMyRequests.filter(r => r.status === 'pending' || r.status.startsWith('processing'));
                const historyRequests = allMyRequests.filter(r => r.status.startsWith('completed') || r.status === 'cancelled');
                renderSection(dom.myPendingRequests, activeRequests, 'requester', "No tienes solicitudes activas.");
                renderSection(dom.myHistoryRequests, historyRequests, 'requester', "No tienes historial de solicitudes.");

            } else { // admin
                const activeReqs = applyFilters(sortedRequests.filter(r => r.status === 'pending' || r.status.startsWith('processing') || r.status === 'shipped'), dom.adminActiveSearchId, dom.adminActiveDateFrom, dom.adminActiveDateTo);
                const completedReqs = applyFilters(sortedRequests.filter(r => r.status.startsWith('completed')), dom.adminHistorySearchId, dom.adminHistoryDateFrom, dom.adminHistoryDateTo);
                const cancelledReqs = applyFilters(sortedRequests.filter(r => r.status === 'cancelled'), dom.adminHistorySearchId, dom.adminHistoryDateFrom, dom.adminHistoryDateTo);
                renderSection(dom.adminTransferRequests, activeReqs, 'admin', "No hay solicitudes activas.");
                renderSection(dom.adminCompletedRequests, completedReqs, 'admin', "No hay solicitudes completadas.");
                renderSection(dom.adminCancelledRequests, cancelledReqs, 'admin', "No hay solicitudes canceladas.");
            }
        }
        
        function renderSection(div, data, role, emptyMessage) { div.innerHTML = ''; if (data.length === 0) { div.innerHTML = `<p class="text-gray-500 italic text-center py-4">${emptyMessage}</p>`; } else { data.forEach(req => div.appendChild(createRequestCard(req, role))); } }
        function renderProducts(productsToRender) { /* ... tu código ... */ }
        function renderCurrentTransfer() { /* ... tu código ... */ }

        // FUNCIÓN MODIFICADA
        function createRequestCard(req, role) {
            const card = document.createElement('div');
            card.className = `p-4 rounded-lg shadow-sm mb-4 ${getRequestStatusColor(req.status)}`;
            const isShipped = req.status === 'shipped';
            const isFinalized = req.status.startsWith('completed');

            const itemsHtml = (req.items || []).map((item, index) => {
                let quantityDisplay = `Solicitado: <b>${item.quantity}</b>`;
                if (item.sentQuantity !== undefined) { quantityDisplay += ` | Enviado: <b>${item.sentQuantity}</b>`; }
                if (item.receivedQuantity !== undefined) {
                    const color = item.receivedQuantity < item.sentQuantity ? 'text-red-600' : 'text-green-700';
                    quantityDisplay += ` | Recibido: <b class="${color}">${item.receivedQuantity}</b>`;
                }
                const receptionInput = (role === 'requester' && isShipped) ? `<div class="flex items-center"><label class="text-sm mr-2">Recibido:</label><input type="number" value="${item.sentQuantity}" data-request-id="${req.id}" data-item-index="${index}" class="reception-qty-input w-20 p-1 border rounded-md text-center"></div>` : ``;
                return `<li class="p-2 rounded-md bg-white flex justify-between items-center text-sm"><div><span class="font-medium text-gray-800">${item.productName}</span><div class="text-xs text-gray-600">${quantityDisplay}</div></div>${receptionInput}</li>`;
            }).join('');
            
            let adminActionsHtml = '';
            if (role === 'admin' && (req.status === 'pending' || req.status.startsWith('processing'))) {
                let buttons = '';
                if (req.status === 'pending') buttons += `<button data-request-id="${req.id}" data-action="start_processing" class="action-btn bg-gray-800 hover:bg-black text-white text-xs font-semibold py-2 px-3 rounded-md mr-1">Iniciar Revisión</button>`;
                if (req.status.startsWith('processing')) buttons += `<button data-request-id="${req.id}" data-action="shipped" class="action-btn bg-blue-600 hover:bg-blue-700 text-white text-xs font-semibold py-2 px-3 rounded-md">Marcar como Enviado</button>`;
                buttons += `<button data-request-id="${req.id}" data-action="cancel" class="action-btn bg-red-600 hover:bg-red-700 text-white text-xs font-semibold py-2 px-3 rounded-md ml-1">Cancelar</button>`;
                adminActionsHtml = `<div class="mt-4 border-t pt-4 text-right">${buttons}</div>`;
            }

            let receptionFormHtml = '';
            if (role === 'requester' && isShipped) {
                receptionFormHtml = `
                    <div class="mt-4 border-t-2 border-red-200 pt-4 space-y-3">
                        <h5 class="font-bold text-md text-red-700">Confirmar Recepción</h5>
                        <div><label class="block text-sm font-medium text-gray-700">Observaciones de Recepción:</label><textarea id="receptionNotes-${req.id}" rows="2" class="w-full mt-1 border rounded-md p-2" placeholder="Ej: La caja llegó golpeada..."></textarea></div>
                        <button data-request-id="${req.id}" class="finalize-reception-btn w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-md">Finalizar y Confirmar Recepción</button>
                    </div>`;
            }

            let receptionEvidenceHtml = '';
            if (isFinalized && req.reception && req.reception.notes) {
                receptionEvidenceHtml = `<div class="mt-3 p-3 bg-green-50 rounded-lg border border-green-200"><p class="text-sm font-semibold text-green-800">Revisión del Solicitante:</p><p class="text-sm text-green-900 italic">"${req.reception.notes}"</p></div>`;
            }

            card.innerHTML = `<div class="flex justify-between items-start"><div><h4 class="font-semibold text-lg text-gray-800">${req.requesterName}</h4><p class="text-sm text-gray-600">ID: ${req.id}</p><span class="inline-block mt-2 px-2 py-1 text-xs font-bold rounded-full ${getRequestStatusColor(req.status)}">${translateStatus(req.status)}</span></div></div><div class="mt-4"><p class="text-sm font-semibold mb-2 text-gray-600">Items:</p><ul class="space-y-2">${itemsHtml}</ul></div>${receptionEvidenceHtml}${adminActionsHtml}${receptionFormHtml}`;
            
            card.querySelectorAll('.action-btn').forEach(b => b.onclick = handleAdminAction);
            card.querySelectorAll('.finalize-reception-btn').forEach(b => b.onclick = handleFinalizeReception);
            return card;
        }
        
        function transformRawJsonToProducts(rawData) { /* ... tu código ... */ }
        async function handleProductUpload() { /* ... tu código ... */ }
        function generateCustomId() { /* ... tu código ... */ }
        function handleUpdateItemQuantity(event) { /* ... tu código ... */ }
        function handleRemoveItem(event) { /* ... tu código ... */ }
        function handleSearchInput() { /* ... tu código ... */ }
        async function handleSubmitTransferForm(event) { /* ... tu código ... */ }
        async function handleDeleteMyRequest(event) { /* ... tu código ... */ }
        
        // FUNCIÓN MODIFICADA
        async function handleAdminAction(event) {
            const { requestId, action } = event.currentTarget.dataset;
            const reqRef = transfersCollection.doc(requestId);
            let updateData = {};
            if (action === 'start_processing') {
                updateData = { status: 'processing_partial_items' };
            } else if (action === 'shipped') {
                if (!confirm("¿Marcar este traslado como ENVIADO? El solicitante deberá confirmar su recepción.")) return;
                updateData = { status: 'shipped' };
            } else if (action === 'cancel') {
                if (!confirm("¿Cancelar esta solicitud?")) return;
                updateData = { status: 'cancelled' };
            } else { return; }
            try { await reqRef.update(updateData); }
            catch(e) { console.error("Error al actualizar la solicitud:", e); }
        }

        async function handleAdminQuantityChange(event) { /* ... tu código ... */ }
        function handleAddToTransfer(event) { /* ... tu código ... */ }
        async function handleSaveAdminNote(event) { /* ... tu código ... */ }
        function exportHistoryToExcel() { /* ... tu código ... */ }
        async function loadAndTransformProducts() { /* ... tu código ... */ }

        // **** NUEVA FUNCIÓN AÑADIDA ****
        async function handleFinalizeReception(event) {
            const button = event.currentTarget;
            const requestId = button.dataset.requestId;
            button.disabled = true;
            button.textContent = 'Procesando...';

            const receptionNotes = document.getElementById(`receptionNotes-${requestId}`).value;
            const qtyInputs = document.querySelectorAll(`.reception-qty-input[data-request-id="${requestId}"]`);
            const reqRef = transfersCollection.doc(requestId);

            try {
                const doc = await reqRef.get();
                if (!doc.exists) throw new Error("El documento del traslado no fue encontrado.");
                
                let items = doc.data().items;
                let isComplete = true;

                qtyInputs.forEach(input => {
                    const index = parseInt(input.dataset.itemIndex, 10);
                    const receivedQty = parseInt(input.value, 10);
                    if (items[index]) {
                        items[index].receivedQuantity = receivedQty;
                        if (receivedQty < items[index].sentQuantity) {
                            isComplete = false;
                        }
                    }
                });

                const newStatus = isComplete ? 'completed' : 'completed_incomplete';
                
                const updatePayload = {
                    status: newStatus,
                    items: items,
                    reception: {
                        notes: receptionNotes,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        finalizedBy: currentUserData.user.email
                    }
                };
                await reqRef.update(updatePayload);
            } catch (error) {
                console.error("Error al finalizar la recepción:", error);
                alert("Ocurrió un error al procesar la recepción. Por favor, intenta de nuevo.");
                button.disabled = false;
                button.textContent = 'Finalizar y Confirmar Recepción';
            }
        }

        // --- 6. INICIALIZACIÓN DE LA APLICACIÓN (sin cambios) ---
        async function initializeApp() { /* ... tu código ... */ }
        initializeApp();
    });
</script>
</body>
</html>
