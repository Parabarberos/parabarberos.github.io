<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traslados Parabarberos</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
<div class="container mx-auto p-4">
    <header class="mb-6">
        <h1 class="text-4xl font-bold text-center text-gray-800">Traslados Parabarberos</h1>
        <div class="mt-4 text-center">
            <label for="roleSelector" class="mr-2">Rol Actual:</label>
            <select id="roleSelector" class="p-2 border rounded-md">
                <option value="requester">Solicitante</option>
                <option value="admin">Administrador</option>
            </select>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <!-- Sección de Solicitante -->
        <div id="requesterSection" class="md:col-span-2 bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Crear Nueva Solicitud de Traslado</h2>
            <div class="mb-4">
                <input type="search" id="searchInput" placeholder="Buscar producto por nombre o ID..."
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>
            <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 min-h-[200px] max-h-[60vh] overflow-y-auto p-2 bg-gray-50 rounded">
                <!-- Productos se cargarán aquí -->
            </div>

            <h3 class="text-xl font-semibold mb-2 text-gray-700">Solicitud Actual</h3>
            <div id="currentTransferRequest" class="space-y-3 mb-6 min-h-[100px] border p-4 rounded-md bg-gray-50">
                <p class="text-gray-500 italic">Selecciona productos para agregar a la solicitud.</p>
            </div>

            <form id="transferForm" class="space-y-4">
                <div>
                    <label for="fromWarehouse" class="block text-sm font-medium text-gray-700">Desde Bodega:</label>
                    <select id="fromWarehouse" name="fromWarehouse" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="Bodega Principal">Bodega Principal</option>
                    </select>
                </div>
                <div>
                    <label for="toWarehouse" class="block text-sm font-medium text-gray-700">Bodega Destino:</label>
                    <select id="toWarehouse" name="toWarehouse" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="Bodega Principal">Bodega Principal</option>
                        <option value="Bodega Cali Centro">Bodega Cali Centro</option>
                        <option value="Bodega Cali Sur">Bodega Cali Sur</option>
                        <option value="Bodega Pasto">Bodega Pasto</option>
                        <option value="Bodega Tulua">Bodega Tulua</option>
                        <option value="Bodega Medellín">Bodega Medellín</option>
                    </select>
                </div>
                <div>
                    <label for="requesterName" class="block text-sm font-medium text-gray-700">Solicitante (Punto de Venta):</label>
                    <select id="requesterName" name="requesterName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="Punto de venta Cali centro">Punto de venta Cali centro</option>
                        <option value="Punto de venta Cali sur">Punto de venta Cali sur</option>
                        <option value="Punto de venta Pasto">Punto de venta Pasto</option>
                        <option value="Punto de venta Tulua">Punto de venta Tulua</option>
                        <option value="Punto de venta Medellin">Punto de venta Medellin</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                    Solicitar Traslado
                </button>
            </form>

            <h3 class="text-xl font-semibold mt-8 mb-4 text-gray-700">Mis Solicitudes Activas</h3>
            <div id="myPendingRequests" class="space-y-3"></div>
             <h3 class="text-xl font-semibold mt-8 mb-4 text-gray-700">Mi Historial de Solicitudes</h3>
            <div id="myHistoryRequests" class="space-y-3"></div>
        </div>

        <!-- Sección de Administrador -->
        <div id="adminSection" class="bg-white p-6 rounded-lg shadow-lg" style="display: none;">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Administrar Solicitudes Activas</h2>
            <div id="adminTransferRequests" class="space-y-4"></div>

            <h2 class="text-2xl font-semibold mt-8 mb-4 text-gray-700">Historial de Traslados</h2>
            
            <h3 class="text-lg font-semibold mb-2 text-gray-600">Completadas</h3>
            <div id="adminCompletedRequests" class="space-y-4 mb-4"></div>

            <h3 class="text-lg font-semibold mb-2 text-gray-600">Canceladas</h3>
            <div id="adminCancelledRequests" class="space-y-4"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- ESTADO GLOBAL DE LA APLICACIÓN ---
    let allProducts = [];
    let productsToShowInitially = 30;
    let productsToAddOnScroll = 15;
    let currentProductOffset = 0;
    let currentTransferItems = [];
    let allTransferRequests = loadTransferRequestsFromLocalStorage();
    let currentUserRole = localStorage.getItem('userRole') || 'requester';

    // --- ACCESO A ELEMENTOS DEL HTML (DOM) ---
    const productListDiv = document.getElementById('productList');
    const currentTransferRequestDiv = document.getElementById('currentTransferRequest');
    const transferForm = document.getElementById('transferForm');
    const fromWarehouseSelect = document.getElementById('fromWarehouse');
    const toWarehouseSelect = document.getElementById('toWarehouse');
    const requesterNameSelect = document.getElementById('requesterName');
    const searchInput = document.getElementById('searchInput');
    const roleSelector = document.getElementById('roleSelector');
    const requesterSection = document.getElementById('requesterSection');
    const adminSection = document.getElementById('adminSection');
    const myPendingRequestsDiv = document.getElementById('myPendingRequests');
    const myHistoryRequestsDiv = document.getElementById('myHistoryRequests');
    const adminTransferRequestsDiv = document.getElementById('adminTransferRequests');
    const adminCompletedRequestsDiv = document.getElementById('adminCompletedRequests');
    const adminCancelledRequestsDiv = document.getElementById('adminCancelledRequests');

    // --- LÓGICA DE ROLES Y VISTAS ---
    function updateUserRoleView() {
        if (currentUserRole === 'requester') {
            requesterSection.style.display = 'block';
            adminSection.style.display = 'none';
            renderAllRequesterSections();
        } else {
            requesterSection.style.display = 'none';
            adminSection.style.display = 'block';
            renderAllAdminSections();
        }
        localStorage.setItem('userRole', currentUserRole);
        roleSelector.value = currentUserRole;
    }

    function handleRoleChange() {
        currentUserRole = roleSelector.value;
        updateUserRoleView();
    }

    // --- RENDERIZADO (DIBUJAR EN PANTALLA) ---
    function renderProducts(productsToRender, append = false) {
        if (!append) {
            productListDiv.innerHTML = '';
        }
        if (productsToRender.length === 0 && !append) {
            productListDiv.innerHTML = '<p class="text-gray-500 col-span-full text-center">No se encontraron productos.</p>';
            return;
        }

        const fragment = document.createDocumentFragment();
        productsToRender.forEach(product => {
            const card = document.createElement('div');
            card.className = 'border p-2 rounded-md shadow hover:shadow-lg transition-shadow bg-white flex flex-col justify-between';
            const safeId = product.id.replace(/[^a-zA-Z0-9-_]/g, '');
            card.innerHTML = `
                <div>
                    <h3 class="text-sm font-semibold text-blue-600" title="${product.description}">${product.name.length > 40 ? product.name.substring(0, 37) + '...' : product.name}</h3>
                    <p class="text-xs text-gray-400 mb-1">ID: ${product.id}</p>
                </div>
                <div class="flex items-center space-x-1 mt-auto pt-1">
                    <input type="number" min="1" value="1" id="qty-${safeId}" class="w-12 border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-xs p-1">
                    <button data-product-id="${product.id}" class="add-to-transfer-btn bg-blue-500 hover:bg-blue-700 text-white text-xs font-bold py-1 px-2 rounded transition-colors">Add</button>
                </div>`;
            fragment.appendChild(card);
        });

        productListDiv.appendChild(fragment);
        productListDiv.querySelectorAll('.add-to-transfer-btn:not([data-listener-attached])').forEach(b => {
             b.onclick = handleAddToTransfer;
             b.setAttribute('data-listener-attached', 'true');
        });
    }

    function displayInitialProducts() {
        currentProductOffset = 0;
        const productsToDisplay = allProducts.slice(0, productsToShowInitially);
        renderProducts(productsToDisplay, false);
        currentProductOffset = productsToDisplay.length;
    }

    function renderCurrentTransfer() {
        currentTransferRequestDiv.innerHTML = '';
        if (currentTransferItems.length === 0) {
            currentTransferRequestDiv.innerHTML = '<p class="text-gray-500 italic">Selecciona productos para agregar a la solicitud.</p>';
            return;
        }

        const ul = document.createElement('ul');
        ul.className = 'space-y-2';
        currentTransferItems.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center p-2 bg-white rounded shadow-sm';
            li.innerHTML = `
                <div>
                    <span class="font-medium">${item.productName}</span>
                    <span class="text-sm text-gray-500">(ID: ${item.productId})</span>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="number" min="1" value="${item.quantity}" data-item-index="${index}" class="w-16 p-1 border-gray-300 rounded-md shadow-sm item-quantity-input text-sm">
                    <button data-item-index="${index}" class="remove-item-btn text-red-500 hover:text-red-700 font-semibold text-xs">Quitar</button>
                </div>`;
            ul.appendChild(li);
        });
        currentTransferRequestDiv.appendChild(ul);

        document.querySelectorAll('.item-quantity-input').forEach(input => input.onchange = handleUpdateItemQuantity);
        document.querySelectorAll('.remove-item-btn').forEach(button => button.onclick = handleRemoveItem);
    }
    
    function renderAllRequesterSections() {
        renderMyPendingRequests();
        renderMyHistoryRequests();
    }
    
    function renderAllAdminSections() {
        renderAdminRequests();
        renderAdminHistoryRequests();
    }

    function renderMyPendingRequests() {
        const selectedRequesterName = requesterNameSelect.value;
        const myRequests = allTransferRequests.filter(req => req.requesterName === selectedRequesterName && (req.status === 'pending' || req.status.startsWith('processing')));
        myPendingRequestsDiv.innerHTML = myRequests.length === 0 ? `<p class="text-gray-500 italic">No tienes solicitudes activas.</p>` : '';
        myRequests.forEach(req => myPendingRequestsDiv.appendChild(createRequestCard(req, 'requester')));
    }

    function renderMyHistoryRequests() {
        const selectedRequesterName = requesterNameSelect.value;
        const myRequests = allTransferRequests.filter(req => req.requesterName === selectedRequesterName && (req.status === 'completed' || req.status === 'cancelled')).sort((a, b) => b.timestamp - a.timestamp);
        myHistoryRequestsDiv.innerHTML = myRequests.length === 0 ? `<p class="text-gray-500 italic">No tienes solicitudes en el historial.</p>` : '';
        myRequests.forEach(req => myHistoryRequestsDiv.appendChild(createRequestCard(req, 'requester')));
    }

    function renderAdminRequests() {
        const activeRequests = allTransferRequests.filter(req => req.status === 'pending' || req.status.startsWith('processing')).sort((a,b) => a.timestamp - b.timestamp);
        adminTransferRequestsDiv.innerHTML = activeRequests.length === 0 ? '<p class="text-gray-500 italic">No hay solicitudes activas para administrar.</p>' : '';
        activeRequests.forEach(req => adminTransferRequestsDiv.appendChild(createRequestCard(req, 'admin')));
    }

    function renderAdminHistoryRequests() {
        const completed = allTransferRequests.filter(req => req.status === 'completed').sort((a, b) => b.timestamp - a.timestamp);
        const cancelled = allTransferRequests.filter(req => req.status === 'cancelled').sort((a, b) => b.timestamp - a.timestamp);
        
        adminCompletedRequestsDiv.innerHTML = completed.length > 0 ? '' : '<p class="text-gray-500 italic">No hay solicitudes completadas.</p>';
        completed.forEach(req => adminCompletedRequestsDiv.appendChild(createRequestCard(req, 'admin')));

        adminCancelledRequestsDiv.innerHTML = cancelled.length > 0 ? '' : '<p class="text-gray-500 italic">No hay solicitudes canceladas.</p>';
        cancelled.forEach(req => adminCancelledRequestsDiv.appendChild(createRequestCard(req, 'admin')));
    }

    function createRequestCard(req, role) {
        const card = document.createElement('div');
        card.className = `p-4 border rounded-md shadow-sm mb-3 ${getRequestStatusColor(req.status)}`;
        
        const itemsHtml = req.items.map((item, index) => {
            let availabilityStatus = '';
            let itemClasses = '';
            if (req.status.startsWith('processing')) {
                if (item.available === true) {
                    availabilityStatus = '<span class="text-green-600 font-bold ml-2">✓ OK</span>';
                } else if (item.available === false) {
                    availabilityStatus = '<span class="text-red-600 font-bold ml-2">✗ Falta</span>';
                    itemClasses = 'text-red-700 line-through';
                }
            }
            
            let itemButtons = '';
            if (role === 'admin' && (req.status === 'pending' || req.status.startsWith('processing'))) {
                itemButtons = `
                    <button data-request-id="${req.id}" data-item-index="${index}" data-available="true" class="mark-item-btn text-green-600 hover:text-green-800 text-xs ml-2 p-1 border border-green-300 rounded">OK</button>
                    <button data-request-id="${req.id}" data-item-index="${index}" data-available="false" class="mark-item-btn text-red-600 hover:text-red-800 text-xs ml-1 p-1 border border-red-300 rounded">Falta</button>
                `;
            }
            return `<li class="${itemClasses} flex justify-between items-center"><span>${item.productName} (x${item.quantity})</span> <div>${availabilityStatus}${itemButtons}</div></li>`;
        }).join('');

        let adminActionsHtml = '';
        if (role === 'admin' && req.status !== 'completed' && req.status !== 'cancelled') {
            let buttons = '';
            if (req.status === 'pending') {
                buttons += `<button data-request-id="${req.id}" data-action="start_processing" class="action-btn bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-2 rounded mr-1">Iniciar Revisión</button>`;
            }
            if (req.status.startsWith('processing')) {
                 buttons += `<button data-request-id="${req.id}" data-action="completed" class="action-btn bg-teal-500 hover:bg-teal-600 text-white text-xs py-1 px-2 rounded">Marcar Realizado</button>`;
                 buttons += ` <button data-request-id="${req.id}" data-action="revert_to_pending" class="action-btn bg-gray-400 hover:bg-gray-500 text-white text-xs py-1 px-2 rounded ml-1">Revertir</button>`;
            }
            buttons += `<button data-request-id="${req.id}" data-action="cancel" class="action-btn bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded ml-1">Cancelar</button>`;
            adminActionsHtml = `<div class="mt-3">${buttons}</div>`;
        }
        
        let requesterActionsHtml = '';
        if (role === 'requester' && req.status === 'pending') {
             requesterActionsHtml = `<button data-request-id="${req.id}" class="delete-my-request-btn bg-red-500 hover:bg-red-700 text-white text-xs py-1 px-2 rounded">Eliminar</button>`;
        }
        
        card.innerHTML = `
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-semibold text-md">ID: ${req.id.substring(0, 8)}</h4>
                    <p class="text-sm">De: ${req.fromWarehouse} → A: <strong>${req.toWarehouse}</strong></p>
                    <p class="text-sm">Solicitante: ${req.requesterName}</p>
                    <p class="text-sm">Estado: <span class="font-medium">${translateStatus(req.status)}</span></p>
                    ${req.notes ? `<p class="text-sm text-orange-600 mt-1"><em>Notas Admin: ${req.notes}</em></p>` : ''}
                </div>
                ${requesterActionsHtml}
            </div>
            <p class="text-sm mt-2 font-medium">Items:</p>
            <ul class="list-disc list-inside text-sm ml-4 space-y-1 mt-1">${itemsHtml}</ul>
            ${adminActionsHtml}
        `;
        
        card.querySelectorAll('.action-btn').forEach(b => b.onclick = handleAdminAction);
        card.querySelectorAll('.mark-item-btn').forEach(b => b.onclick = handleMarkItemAvailability);
        card.querySelectorAll('.delete-my-request-btn').forEach(b => b.onclick = handleDeleteMyRequest);

        return card;
    }

    // --- MANEJADORES DE EVENTOS (HANDLERS) ---
    function handleAddToTransfer(event) {
        const button = event.currentTarget;
        const productId = button.dataset.productId;
        const product = allProducts.find(p => p.id === productId);
        if (!product) return;

        const safeId = product.id.replace(/[^a-zA-Z0-9-_]/g, '');
        const qtyInput = document.getElementById(`qty-${safeId}`);
        const quantity = parseInt(qtyInput.value, 10);

        if (isNaN(quantity) || quantity < 1) { alert("Cantidad inválida."); return; }

        const existingItem = currentTransferItems.find(i => i.productId === productId);
        if (existingItem) {
            existingItem.quantity += quantity;
        } else {
            currentTransferItems.push({ productId, productName: product.name, quantity });
        }
        qtyInput.value = "1";
        renderCurrentTransfer();
        saveCurrentTransferToLocalStorage();
    }

    function handleUpdateItemQuantity(event) {
        const input = event.currentTarget;
        const itemIndex = parseInt(input.dataset.itemIndex, 10);
        const newQuantity = parseInt(input.value, 10);
        if (isNaN(newQuantity) || newQuantity < 1) {
            alert("Cantidad inválida.");
            input.value = currentTransferItems[itemIndex].quantity;
            return;
        }
        currentTransferItems[itemIndex].quantity = newQuantity;
        saveCurrentTransferToLocalStorage();
    }

    function handleRemoveItem(event) {
        const button = event.currentTarget;
        const itemIndex = parseInt(button.dataset.itemIndex, 10);
        currentTransferItems.splice(itemIndex, 1);
        renderCurrentTransfer();
        saveCurrentTransferToLocalStorage();
    }

    function handleSubmitTransferForm(event) {
        event.preventDefault();
        if (currentTransferItems.length === 0) {
            alert("Agrega productos antes de enviar.");
            return;
        }
        const newReq = {
            id: `TR-${Date.now()}-${Math.random().toString(36).substring(2, 7)}`,
            items: JSON.parse(JSON.stringify(currentTransferItems)),
            fromWarehouse: fromWarehouseSelect.value,
            toWarehouse: toWarehouseSelect.value,
            requesterName: requesterNameSelect.value,
            status: 'pending',
            timestamp: Date.now()
        };
        allTransferRequests.push(newReq);
        saveTransferRequestsToLocalStorage();
        currentTransferItems = [];
        renderCurrentTransfer();
        saveCurrentTransferToLocalStorage();
        renderAllRequesterSections();
        if (currentUserRole === 'admin') renderAllAdminSections();
        alert("Solicitud enviada con éxito.");
    }

    function handleDeleteMyRequest(event) {
        const requestId = event.currentTarget.dataset.requestId;
        if (confirm("¿Eliminar esta solicitud?")) {
            allTransferRequests = allTransferRequests.filter(req => req.id !== requestId);
            saveTransferRequestsToLocalStorage();
            renderAllRequesterSections();
        }
    }

    function handleMarkItemAvailability(event) {
        const button = event.currentTarget;
        const { requestId, itemIndex, available } = button.dataset;
        const request = allTransferRequests.find(r => r.id === requestId);
        if (request && request.items[itemIndex]) {
            request.items[itemIndex].available = (available === 'true');
            if (request.status === 'pending') {
                request.status = 'processing_partial_items';
            }
            saveTransferRequestsToLocalStorage();
            renderAllAdminSections();
        }
    }

    function handleAdminAction(event) {
        const btn = event.currentTarget;
        const { requestId, action } = btn.dataset;
        const req = allTransferRequests.find(r => r.id === requestId);
        if (!req) return;

        switch (action) {
            case 'start_processing':
                req.items.forEach(item => item.available = undefined);
                req.status = 'processing_partial_items';
                req.notes = "Revisión iniciada.";
                break;
            case 'completed':
                if (req.items.some(item => item.available === false) && !confirm("Hay ítems faltantes. ¿Completar igual?")) return;
                req.status = 'completed';
                req.notes = (req.notes || "") + " Traslado completado.";
                break;
            case 'revert_to_pending':
                if (confirm("¿Revertir a Pendiente?")) {
                    req.status = 'pending';
                    req.items.forEach(item => item.available = undefined);
                    req.notes = "Revertido a pendiente.";
                }
                break;
            case 'cancel':
                if (confirm("¿Cancelar esta solicitud?")) {
                    req.status = 'cancelled';
                    req.notes = (req.notes || "") + " Solicitud cancelada.";
                }
                break;
        }
        saveTransferRequestsToLocalStorage();
        renderAllAdminSections();
        renderAllRequesterSections();
    }

    function handleSearchInput() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        if (searchTerm === "") {
            displayInitialProducts();
            return;
        }
        if (searchTerm.length > 1) {
            const filtered = allProducts.filter(p => p.name.toLowerCase().includes(searchTerm) || p.description.toLowerCase().includes(searchTerm) || p.id.toLowerCase().includes(searchTerm));
            renderProducts(filtered, false);
        }
    }

    // --- LOCALSTORAGE Y HELPERS ---
    function saveTransferRequestsToLocalStorage() { localStorage.setItem('transferRequests', JSON.stringify(allTransferRequests)); }
    function loadTransferRequestsFromLocalStorage() { const d = localStorage.getItem('transferRequests'); return d ? JSON.parse(d) : []; }
    function saveCurrentTransferToLocalStorage() { localStorage.setItem('currentTransferDraft', JSON.stringify(currentTransferItems)); }
    function loadCurrentTransferFromLocalStorage() { const d = localStorage.getItem('currentTransferDraft'); currentTransferItems = d ? JSON.parse(d) : []; }
    function getRequestStatusColor(s) { return {'pending':'bg-yellow-50 border-yellow-400','processing_all_items':'bg-blue-50 border-blue-400','processing_partial_items':'bg-orange-50 border-orange-400','completed':'bg-green-100 border-green-500','cancelled':'bg-red-100 border-red-400'}[s]||'bg-gray-50 border-gray-300'; }
    function translateStatus(s) { return {'pending':'Pendiente','processing_all_items':'En Revisión (Todo OK)','processing_partial_items':'En Revisión (Parcial)','completed':'Realizado','cancelled':'Cancelado'}[s]||s; }

    // --- CARGA DE DATOS DE PRODUCTOS ---
    function loadAndTransformProducts() {
        const rawData = [
            // ================= ¡IMPORTANTE! PEGA AQUÍ TUS PRODUCTOS =================
            // Ejemplo de cómo debe verse (CADA LÍNEA TERMINA EN COMA, EXCEPTO LA ÚLTIMA):
            { "738678000984 - DAILY CLEANS SHAMPOO AMERICAN CREW X 250ML": "669316222034 - BALSAMO AMERICAN CREW 170 ML" },
            { "738678000984 - DAILY CLEANS SHAMPOO AMERICAN CREW X 250ML": "669316408063 - FIBER CREAM AMERICAN CREW 100ML" },
            { "738678000984 - DAILY CLEANS SHAMPOO AMERICAN CREW X 250ML": "738678002674 - CERA AMERICAN CREW DEFINING PASTE 85G ROJO" }
            // PEGA EL RESTO DE TUS PRODUCTOS AQUÍ, MANTENIENDO EL FORMATO
            // =======================================================================
        ];

        if (!rawData || rawData.length === 0) {
            productListDiv.innerHTML = '<p class="text-red-500 col-span-full text-center">Error: Agrega tus productos en el archivo index.html.</p>';
            return [];
        }

        const uniqueProductStrings = new Set();
        rawData.forEach(item => {
            Object.keys(item).forEach(key => uniqueProductStrings.add(key));
            Object.values(item).forEach(val => val && uniqueProductStrings.add(val));
        });

        const productsMap = new Map();
        let genericCounter = 1;
        Array.from(uniqueProductStrings).forEach(fullProductName => {
            const parts = String(fullProductName).split(' - ');
            let idPart, namePart;
            if (parts.length > 1 && (/\d/.test(parts[0].trim()) || /^[a-zA-Z]{2,}/.test(parts[0].trim()))) {
                idPart = parts[0].trim().replace(/\s+/g, '-');
                namePart = parts.slice(1).join(' - ').trim();
            } else {
                idPart = `prod-gen-${genericCounter++}`;
                namePart = fullProductName;
            }
            let finalId = idPart;
            let idCounter = 1;
            while (productsMap.has(finalId)) {
                finalId = `${idPart}_${idCounter++}`;
            }
            productsMap.set(finalId, { id: finalId, name: namePart, description: fullProductName });
        });
        return Array.from(productsMap.values()).sort((a, b) => a.name.localeCompare(b.name));
    }

    // --- INICIALIZACIÓN DE LA APP ---
    function initializeApp() {
        allProducts = loadAndTransformProducts();
        loadCurrentTransferFromLocalStorage();
        displayInitialProducts();
        renderCurrentTransfer();
        roleSelector.onchange = handleRoleChange;
        requesterNameSelect.onchange = renderAllRequesterSections;
        transferForm.onsubmit = handleSubmitTransferForm;
        searchInput.oninput = handleSearchInput;
        updateUserRoleView();
    }

    initializeApp();
});
</script>

</body>
</html>
