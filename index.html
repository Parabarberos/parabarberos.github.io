<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRASLADOS ENTRE BODEGAS</title>
    <link rel="icon" type="image/jpeg" href="https://parabarberos.github.io/2.jpg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-12 text-center">
    <div class="inline-block p-2 bg-white rounded-full shadow-lg mx-auto mb-6 border-4 border-gray-200">
        <img src="https://parabarberos.github.io/2.jpg" alt="Logo Parabarberos" class="h-24 w-24 md:h-32 md:w-32 rounded-full">
    </div>
    <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 tracking-tight">TRASLADOS ENTRE BODEGAS</h1>
    <div class="mt-8">
        <label for="roleSelector" class="mr-2 text-base font-semibold text-gray-600">USUARIO:</label>
        <select id="roleSelector" class="p-2 border-2 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-red-500 focus:border-red-500 font-semibold">
            <option value="requester">Solicitante</option>
            <option value="admin">Administrador</option>
        </select>
    </div>
</header>

        <!-- VISTA DE SOLICITANTE -->
        <div id="requesterView" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <div class="bg-white p-6 rounded-xl shadow-lg card">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Nueva solicitud de traslado</h2>
                    <div class="mb-4">
                        <input type="search" id="searchInput" placeholder="Buscar producto..." class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4 mb-6 min-h-[200px] max-h-[50vh] overflow-y-auto p-4 bg-gray-50 rounded-lg"></div>
                    <h3 class="text-xl font-semibold mb-3 text-gray-800"> Productos seleccionados</h3>
                    <div id="currentTransferRequest" class="space-y-3 mb-6 min-h-[100px] max-h-[40vh] overflow-y-auto p-4 bg-gray-50 rounded-lg"></div>
                    <form id="transferForm" class="space-y-4 border-t pt-6">
                        <h3 class="text-xl font-semibold mb-3 text-gray-800"> Detalles de traslado</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="toWarehouse" class="block text-sm font-medium text-gray-700">Bodega Destino:</label>
                                <select id="toWarehouse" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"></select>
                            </div>
                            <div>
                                <label for="requesterName" class="block text-sm font-medium text-gray-700">Solicitante:</label>
                                <select id="requesterName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm"></select>
                            </div>
                            <div>
                                <label for="deliveryDate" class="block text-sm font-medium text-gray-700">Fecha de solicitud</label>
                                <input type="date" id="deliveryDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm">
                            </div>
                        </div>
                        <input type="hidden" id="fromWarehouse" value="Bodega Principal">
                        <div>
    <label for="requesterNotes" class="block text-sm font-medium text-gray-700">Observaciones</label>
    <textarea id="requesterNotes" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Ej: Necesito este pedido con urgencia para un cliente..."></textarea>
</div>
                        <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg">
                            ENVIAR SOLICITUD DE TRASLADO
                        </button>
                    </form>
                </div>
            </div>
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg card">
                <h3 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Mis solicitudes</h3>
                <div class="space-y-2 mb-4">
                    <input type="text" id="requesterSearchId" placeholder="Buscar por ID..." class="w-full px-3 py-2 border rounded-lg">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" id="requesterDateFrom" class="w-full px-3 py-2 border rounded-lg text-sm" title="Fecha Desde">
                        <input type="date" id="requesterDateTo" class="w-full px-3 py-2 border rounded-lg text-sm" title="Fecha Hasta">
                    </div>
                </div>
                <div class="max-h-[80vh] overflow-y-auto">
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Activas</h4>
                    <div id="myPendingRequests" class="space-y-4 mb-6"></div>
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Historial</h4>
                    <div id="myHistoryRequests" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <!-- VISTA DE ADMINISTRADOR -->
<div id="adminView" class="grid grid-cols-1 lg:grid-cols-2 gap-8" style="display: none;">
    <div id="productManagementCard" class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg card">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Gestión de Productos</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
            <div>
                <p class="text-sm text-gray-600 mb-2">Para actualizar la lista, sube un archivo <strong>JSON</strong> con el siguiente formato:</p>
                <pre class="bg-gray-100 p-3 rounded-lg text-xs text-gray-700 overflow-x-auto">
                    [
                    {
                    "id": "P001",
                    "name": "Shampoo de Bergamota",
                    "description": "Botella de 250ml"
                    },
                    {
                    "id": "P002",
                    "name": "Cera para peinar",
                    "description": "Fijación fuerte, 100g"
                    }
                    ]
                </pre>
            </div>
            <div class="text-center">
                <label for="productFile" class="cursor-pointer w-full inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg">
                    Seleccionar Archivo JSON
                </label>
                <input type="file" id="productFile" class="hidden" accept=".json">
                <button id="uploadProductsBtn" class="mt-4 w-full bg-gray-800 hover:bg-black text-white font-bold py-3 px-4 rounded-lg shadow-lg">
                    Actualizar Base de Datos de Productos
                </button>
                <p id="uploadStatus" class="mt-3 text-sm font-medium"></p>
            </div>
        </div>
    </div>
    
    <!-- COLUMNA 1: TRASLADOS PENDIENTES (La que había desaparecido) -->
    <div class="bg-white p-6 rounded-xl shadow-lg card">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-3">Traslados pendientes</h2>
        <div class="space-y-2 mb-4">
            <input type="text" id="adminActiveSearchId" placeholder="Buscar por ID o Solicitante..." class="w-full px-3 py-2 border rounded-lg">
            <div class="grid grid-cols-2 gap-2">
                <input type="date" id="adminActiveDateFrom" class="w-full px-3 py-2 border rounded-lg text-sm" title="Fecha Desde">
                <input type="date" id="adminActiveDateTo" class="w-full px-3 py-2 border rounded-lg text-sm" title="Fecha Hasta">
            </div>
        </div>
        <div id="adminTransferRequests" class="space-y-4 max-h-[80vh] overflow-y-auto"></div>
    </div>

    <!-- COLUMNA 2: HISTORIAL (Con el botón de exportar bien colocado) -->
    <div class="bg-white p-6 rounded-xl shadow-lg card">
        
        <!-- ESTA ES LA SECCIÓN CORREGIDA -->
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h2 class="text-2xl font-semibold text-gray-800">Historial</h2>
            <button id="exportExcelBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center space-x-2">
                <!-- Icono SVG para el botón -->
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <span>Exportar a Excel</span>
            </button>
        </div>
        
        <div class="space-y-2 mb-4">
            <input type="text" id="adminHistorySearchId" placeholder="Buscar por ID o Solicitante..." class="w-full px-3 py-2 border rounded-lg">
            <div class="grid grid-cols-2 gap-2">
                <input type="date" id="adminHistoryDateFrom" class="w-full px-3 py-2 border rounded-lg text-sm" title="Fecha Desde">
                <input type="date" id="adminHistoryDateTo" class="w-full px-3 py-2 border rounded-lg text-sm" title="Fecha Hasta">
            </div>
        </div>
        <div class="max-h-[80vh] overflow-y-auto">
            <h3 class="text-lg font-medium text-gray-700 mb-2">Completadas</h3>
            <div id="adminCompletedRequests" class="space-y-4 mb-6"></div>
            <h3 class="text-lg font-medium text-gray-700 mb-2">Canceladas</h3>
            <div id="adminCancelledRequests" class="space-y-4"></div>
        </div>
    </div>
</div>

<!-- REEMPLAZA TU SCRIPT COMPLETO CON ESTO -->
<script>
    document.addEventListener('DOMContentLoaded', () => {

        const firebaseConfig = {
            apiKey: "AIzaSyBmmNg525KrnOTsebzAV9dzfsKiq3o-0iQ",
            authDomain: "base-de-datos-traslados.firebaseapp.com",
            projectId: "base-de-datos-traslados",
            storageBucket: "base-de-datos-traslados.appspot.com",
            messagingSenderId: "569583717634",
            appId: "1:569583717634:web:f7baa7aaf66a639624461b",
            measurementId: "G-9CSBCGJRGS"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const transfersCollection = db.collection("transferencias");
        const productsCollection = db.collection("products"); // Nueva colección

        let allProducts = [];
        let currentTransferItems = JSON.parse(localStorage.getItem('currentTransferDraft')) || [];
        let allTransferRequests = [];
        let currentUserRole = 'requester';
        const ADMIN_PASSWORD = "Traslados1234";
        const POINT_OF_SALE_PASSWORDS = {
            'Punto de venta Cali centro': 'calicentro77',
            'Punto de venta Cali sur': 'calisur88',
            'Punto de venta Pasto': 'pasto99',
            'Punto de venta Tulua': 'tulua11',
            'Punto de venta Medellin': 'medellin22'
        };
        let lastSelectedRequester = '';
        
        const dom = {
            // ... (Asegúrate de tener todos tus elementos del DOM aquí, como en tu código original)
            productList: document.getElementById('productList'),
            currentTransferRequest: document.getElementById('currentTransferRequest'),
            transferForm: document.getElementById('transferForm'),
            toWarehouse: document.getElementById('toWarehouse'),
            requesterName: document.getElementById('requesterName'),
            searchInput: document.getElementById('searchInput'),
            roleSelector: document.getElementById('roleSelector'),
            requesterView: document.getElementById('requesterView'),
            adminView: document.getElementById('adminView'),
            myPendingRequests: document.getElementById('myPendingRequests'),
            myHistoryRequests: document.getElementById('myHistoryRequests'),
            adminTransferRequests: document.getElementById('adminTransferRequests'),
            adminCompletedRequests: document.getElementById('adminCompletedRequests'),
            adminCancelledRequests: document.getElementById('adminCancelledRequests'),
            requesterSearchId: document.getElementById('requesterSearchId'),
            requesterDateFrom: document.getElementById('requesterDateFrom'),
            requesterDateTo: document.getElementById('requesterDateTo'),
            adminActiveSearchId: document.getElementById('adminActiveSearchId'),
            adminActiveDateFrom: document.getElementById('adminActiveDateFrom'),
            adminActiveDateTo: document.getElementById('adminActiveDateTo'),
            adminHistorySearchId: document.getElementById('adminHistorySearchId'),
            adminHistoryDateFrom: document.getElementById('adminHistoryDateFrom'),
            adminHistoryDateTo: document.getElementById('adminHistoryDateTo'),
            exportExcelBtn: document.getElementById('exportExcelBtn'),
            productManagementCard: document.getElementById('productManagementCard'),
            productFile: document.getElementById('productFile'),
            uploadProductsBtn: document.getElementById('uploadProductsBtn'),
            uploadStatus: document.getElementById('uploadStatus'),
        };

        // --- FUNCIONES AUXILIARES ---

        const getRequestStatusColor = (s) => ({'pending':'border-l-4 border-gray-400 bg-gray-50','processing_partial_items':'border-l-4 border-red-500 bg-red-50','completed':'border-l-4 border-black bg-gray-100','cancelled':'border-l-4 border-red-700 bg-red-100'}[s]||'border-l-4 border-gray-300');
        const translateStatus = (s) => ({'pending':'Pendiente','processing_partial_items':'En Revisión','completed':'Realizado','cancelled':'Cancelado'}[s]||s);
        
        function generateCustomId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const nums = '0123456789';
            let result = '';
            let startWithLetter = Math.random() < 0.5;
            for (let i = 0; i < 7; i++) {
                if ((i % 2 === 0 && startWithLetter) || (i % 2 !== 0 && !startWithLetter)) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                } else {
                    result += nums.charAt(Math.floor(Math.random() * nums.length));
                }
            }
            return result;
        }

        // --- CARGA DE DATOS ---

        async function loadAndTransformProducts() {
            try {
                const snapshot = await productsCollection.orderBy("name").get();
                if (snapshot.empty) {
                    console.warn("La colección 'products' está vacía. El admin debe subir una lista.");
                    return []; 
                }
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error("ERROR AL CARGAR PRODUCTOS:", error);
                alert("No se pudo cargar la lista de productos. Revisa las REGLAS DE SEGURIDAD de Firestore o la conexión a internet. La app puede no funcionar correctamente.");
                return [];
            }
        }

        // --- RENDERIZADO DE LA UI ---
        // (Aquí van todas tus funciones de renderizado: renderProducts, renderCurrentTransfer, createRequestCard, renderSection, renderAllSections, etc. Cópialas desde tu código original)
        // ...
        
        // --- MANEJADORES DE EVENTOS ---
        // (Aquí van todas tus funciones 'handle...': handleRoleChange, handleSubmitTransferForm, handleProductUpload, etc. Cópialas desde tu código original)
        // ...

        // --- INICIALIZACIÓN DE LA APP ---

        function initializeApp() {
            // Primero, configurar todos los listeners y elementos estáticos
            
            // Renderiza la UI inicial con datos vacíos o de localStorage
            renderProducts(allProducts); 
            renderCurrentTransfer();

            const warehouseOptions = ['Bodega Cali Centro', 'Bodega Cali Sur', 'Bodega Pasto', 'Bodega Tulua', 'Bodega Medellín'];
            const requesterOptions = ['Punto de venta Cali centro', 'Punto de venta Cali sur', 'Punto de venta Pasto', 'Punto de venta Tulua', 'Punto de venta Medellin'];
            dom.toWarehouse.innerHTML = '<option value="" selected disabled>-- Seleccione una bodega --</option>' + warehouseOptions.map(w => `<option value="${w}">${w}</option>`).join('');
            dom.requesterName.innerHTML = '<option value="" selected disabled>-- Seleccione un punto de venta --</option>' + requesterOptions.map(r => `<option value="${r}">${r}</option>`).join('');
            
            // Asigna todos los manejadores de eventos
            dom.roleSelector.onchange = handleRoleChange;
            dom.requesterName.onchange = () => { /* Tu lógica de contraseña aquí */ };
            dom.transferForm.onsubmit = handleSubmitTransferForm;
            dom.searchInput.oninput = handleSearchInput;
            dom.uploadProductsBtn.onclick = handleProductUpload;
            // ... (y todos los demás)

            // Ahora, inicia las cargas de datos asíncronas
            loadAndTransformProducts().then(products => {
                allProducts = products;
                renderProducts(allProducts); // Vuelve a renderizar con los datos reales
            });

            transfersCollection.orderBy("timestamp", "desc").onSnapshot(snapshot => {
                allTransferRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAllSections();
            }, error => {
                console.error("Error al conectar con la colección 'transferencias': ", error);
            });

            // Finalmente, actualiza la vista inicial
            updateUserRoleView();
        }

        // Reemplaza las secciones "..." con el código real de tus funciones
        // Por ejemplo, aquí pongo la de updateUserRoleView completa:
        function updateUserRoleView() {
            localStorage.setItem('userRole', currentUserRole);
            dom.roleSelector.value = currentUserRole;
            dom.requesterView.style.display = (currentUserRole === 'requester') ? 'grid' : 'none';
            dom.adminView.style.display = (currentUserRole === 'admin') ? 'grid' : 'none';
            if (dom.productManagementCard) {
                dom.productManagementCard.style.display = (currentUserRole === 'admin') ? 'block' : 'none';
            }
            renderAllSections();
        }

        // Y aquí todas las demás...
        // ...

        // ¡Y finalmente, llama a la función para empezar todo!
        initializeApp();
    });
</script>
