<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traslados Parabarberos (Prueba)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Scripts de Firebase (versión compat para funcionar sin 'import') -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 font-sans">
<div class="container mx-auto p-4">
    <header class="mb-6">
        <h1 class="text-4xl font-bold text-center text-gray-800">Traslados Parabarberos</h1>
        <div class="mt-4 text-center">
            <label for="roleSelector" class="mr-2">Rol Actual:</label>
            <select id="roleSelector" class="p-2 border rounded-md">
                <option value="requester">Solicitante</option>
                <option value="admin">Administrador</option>
            </select>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <!-- Sección de Solicitante -->
        <div id="requesterSection" class="md:col-span-2 bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Crear Nueva Solicitud de Traslado</h2>
            <div class="mb-4">
                <input type="search" id="searchInput" placeholder="Buscar producto por nombre o ID..."
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>
            <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 min-h-[200px] max-h-[60vh] overflow-y-auto p-2 bg-gray-50 rounded"></div>
            <h3 class="text-xl font-semibold mb-2 text-gray-700">Solicitud Actual</h3>
            <div id="currentTransferRequest" class="space-y-3 mb-6 min-h-[100px] border p-4 rounded-md bg-gray-50"></div>
            <form id="transferForm" class="space-y-4">
                <div>
                    <label for="fromWarehouse" class="block text-sm font-medium text-gray-700">Desde Bodega:</label>
                    <select id="fromWarehouse" name="fromWarehouse" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="Bodega Principal">Bodega Principal</option>
                    </select>
                </div>
                <div>
                    <label for="toWarehouse" class="block text-sm font-medium text-gray-700">Bodega Destino:</label>
                    <select id="toWarehouse" name="toWarehouse" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="Bodega Principal">Bodega Principal</option>
                        <option value="Bodega Cali Centro">Bodega Cali Centro</option>
                        <option value="Bodega Cali Sur">Bodega Cali Sur</option>
                        <option value="Bodega Pasto">Bodega Pasto</option>
                        <option value="Bodega Tulua">Bodega Tulua</option>
                        <option value="Bodega Medellín">Bodega Medellín</option>
                    </select>
                </div>
                <div>
                    <label for="requesterName" class="block text-sm font-medium text-gray-700">Solicitante (Punto de Venta):</label>
                    <select id="requesterName" name="requesterName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="Punto de venta Cali centro">Punto de venta Cali centro</option>
                        <option value="Punto de venta Cali sur">Punto de venta Cali sur</option>
                        <option value="Punto de venta Pasto">Punto de venta Pasto</option>
                        <option value="Punto de venta Tulua">Punto de venta Tulua</option>
                        <option value="Punto de venta Medellin">Punto de venta Medellin</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition-colors">
                    Solicitar Traslado
                </button>
            </form>
            <h3 class="text-xl font-semibold mt-8 mb-4 text-gray-700">Mis Solicitudes Activas</h3>
            <div id="myPendingRequests" class="space-y-3"></div>
             <h3 class="text-xl font-semibold mt-8 mb-4 text-gray-700">Mi Historial de Solicitudes</h3>
            <div id="myHistoryRequests" class="space-y-3"></div>
        </div>
        <!-- Sección de Administrador -->
        <div id="adminSection" class="bg-white p-6 rounded-lg shadow-lg" style="display: none;">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">Administrar Solicitudes Activas</h2>
            <div id="adminTransferRequests" class="space-y-4"></div>
            <h2 class="text-2xl font-semibold mt-8 mb-4 text-gray-700">Historial de Traslados</h2>
            <h3 class="text-lg font-semibold mb-2 text-gray-600">Completadas</h3>
            <div id="adminCompletedRequests" class="space-y-4 mb-4"></div>
            <h3 class="text-lg font-semibold mb-2 text-gray-600">Canceladas</h3>
            <div id="adminCancelledRequests" class="space-y-4"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const firebaseConfig = {
      apiKey: "AIzaSyBmmNg525KrnOTsebzAV9dzfsKiq3o-0iQ",
      authDomain: "base-de-datos-traslados.firebaseapp.com",
      projectId: "base-de-datos-traslados",
      storageBucket: "base-de-datos-traslados.appspot.com",
      messagingSenderId: "569583717634",
      appId: "1:569583717634:web:f7baa7aaf66a639624461b",
      measurementId: "G-9CSBCGJRGS"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const transfersCollection = db.collection("transferencias");

    let allProducts = [];
    let currentTransferItems = JSON.parse(localStorage.getItem('currentTransferDraft')) || [];
    let allTransferRequests = [];
    let currentUserRole = localStorage.getItem('userRole') || 'requester';

    const productListDiv = document.getElementById('productList');
    const currentTransferRequestDiv = document.getElementById('currentTransferRequest');
    const transferForm = document.getElementById('transferForm');
    const fromWarehouseSelect = document.getElementById('fromWarehouse');
    const toWarehouseSelect = document.getElementById('toWarehouse');
    const requesterNameSelect = document.getElementById('requesterName');
    const searchInput = document.getElementById('searchInput');
    const roleSelector = document.getElementById('roleSelector');
    const requesterSection = document.getElementById('requesterSection');
    const adminSection = document.getElementById('adminSection');
    const myPendingRequestsDiv = document.getElementById('myPendingRequests');
    const myHistoryRequestsDiv = document.getElementById('myHistoryRequests');
    const adminTransferRequestsDiv = document.getElementById('adminTransferRequests');
    const adminCompletedRequestsDiv = document.getElementById('adminCompletedRequests');
    const adminCancelledRequestsDiv = document.getElementById('adminCancelledRequests');
    
    function updateUserRoleView() {
        localStorage.setItem('userRole', currentUserRole);
        roleSelector.value = currentUserRole;
        if (currentUserRole === 'requester') {
            requesterSection.style.display = 'block';
            adminSection.style.display = 'none';
        } else {
            requesterSection.style.display = 'none';
            adminSection.style.display = 'block';
        }
        renderAllSections();
    }
    
    function renderAllSections() {
        if (currentUserRole === 'requester') {
            renderMyPendingRequests();
            renderMyHistoryRequests();
        } else {
            renderAdminRequests();
            renderAdminHistoryRequests();
        }
    }

    function renderProducts(productsToRender) {
        productListDiv.innerHTML = '';
        if (!productsToRender || productsToRender.length === 0) {
            productListDiv.innerHTML = '<p class="text-gray-500 col-span-full text-center">No se encontraron productos.</p>';
            return;
        }
        const fragment = document.createDocumentFragment();
        productsToRender.forEach(product => {
            const card = document.createElement('div');
            card.className = 'border p-2 rounded-md shadow hover:shadow-lg transition-shadow bg-white flex flex-col justify-between';
            const safeId = product.id.replace(/[^a-zA-Z0-9-_]/g, '');
            card.innerHTML = `
                <div>
                    <h3 class="text-sm font-semibold text-blue-600" title="${product.description}">${product.name}</h3>
                    <p class="text-xs text-gray-400 mb-1">ID: ${product.id}</p>
                </div>
                <div class="flex items-center space-x-1 mt-auto pt-1">
                    <input type="number" min="1" value="1" id="qty-${safeId}" class="w-12 border-gray-300 rounded-md shadow-sm text-xs p-1">
                    <button data-product-id="${product.id}" class="add-to-transfer-btn bg-blue-500 hover:bg-blue-700 text-white text-xs font-bold py-1 px-2 rounded">Add</button>
                </div>`;
            fragment.appendChild(card);
        });
        productListDiv.appendChild(fragment);
        productListDiv.querySelectorAll('.add-to-transfer-btn').forEach(b => {
             b.onclick = handleAddToTransfer;
        });
    }

    function displayInitialProducts() {
        renderProducts(allProducts.slice(0, 50));
    }
    
    function renderCurrentTransfer() {
        currentTransferRequestDiv.innerHTML = '';
        if (currentTransferItems.length === 0) {
            currentTransferRequestDiv.innerHTML = '<p class="text-gray-500 italic">Selecciona productos.</p>';
            return;
        }
        const ul = document.createElement('ul');
        ul.className = 'space-y-2';
        currentTransferItems.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center p-2 bg-white rounded shadow-sm';
            li.innerHTML = `
                <div>
                    <span class="font-medium">${item.productName}</span> <span class="text-sm text-gray-500">(ID: ${item.productId})</span>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="number" min="1" value="${item.quantity}" data-item-index="${index}" class="w-16 p-1 border rounded item-quantity-input text-sm">
                    <button data-item-index="${index}" class="remove-item-btn text-red-500 hover:text-red-700 font-semibold text-xs">Quitar</button>
                </div>`;
            ul.appendChild(li);
        });
        currentTransferRequestDiv.appendChild(ul);
        document.querySelectorAll('.item-quantity-input').forEach(input => input.onchange = handleUpdateItemQuantity);
        document.querySelectorAll('.remove-item-btn').forEach(button => button.onclick = handleRemoveItem);
    }
    
    function renderMyPendingRequests() {
        const selectedRequester = requesterNameSelect.value;
        const myRequests = allTransferRequests.filter(r => r.requesterName === selectedRequester && (r.status === 'pending' || r.status.startsWith('processing'))).sort((a,b) => b.timestamp - a.timestamp);
        myPendingRequestsDiv.innerHTML = myRequests.length === 0 ? '<p class="text-gray-500 italic">No hay solicitudes activas.</p>' : '';
        myRequests.forEach(req => myPendingRequestsDiv.appendChild(createRequestCard(req, 'requester')));
    }

    function renderMyHistoryRequests() {
        const selectedRequester = requesterNameSelect.value;
        const myRequests = allTransferRequests.filter(r => r.requesterName === selectedRequester && (r.status === 'completed' || r.status === 'cancelled')).sort((a,b) => b.timestamp - a.timestamp);
        myHistoryRequestsDiv.innerHTML = myRequests.length === 0 ? '<p class="text-gray-500 italic">No hay historial.</p>' : '';
        myRequests.forEach(req => myHistoryRequestsDiv.appendChild(createRequestCard(req, 'requester')));
    }

    function renderAdminRequests() {
        const active = allTransferRequests.filter(r => r.status === 'pending' || r.status.startsWith('processing')).sort((a,b) => a.timestamp - b.timestamp);
        adminTransferRequestsDiv.innerHTML = active.length === 0 ? '<p class="text-gray-500 italic">No hay solicitudes activas.</p>' : '';
        active.forEach(req => adminTransferRequestsDiv.appendChild(createRequestCard(req, 'admin')));
    }

    function renderAdminHistoryRequests() {
        const completed = allTransferRequests.filter(r => r.status === 'completed').sort((a,b) => b.timestamp - a.timestamp);
        const cancelled = allTransferRequests.filter(r => r.status === 'cancelled').sort((a,b) => b.timestamp - a.timestamp);
        
        adminCompletedRequestsDiv.innerHTML = completed.length === 0 ? '<p class="text-gray-500 italic">No hay completadas.</p>' : '';
        completed.forEach(req => adminCompletedRequestsDiv.appendChild(createRequestCard(req, 'admin')));

        adminCancelledRequestsDiv.innerHTML = cancelled.length === 0 ? '<p class="text-gray-500 italic">No hay canceladas.</p>' : '';
        cancelled.forEach(req => adminCancelledRequestsDiv.appendChild(createRequestCard(req, 'admin')));
    }
    
    function createRequestCard(req, role) {
        const card = document.createElement('div');
        card.className = `p-4 border rounded-md shadow-sm mb-3 ${getRequestStatusColor(req.status)}`;
        const itemsHtml = req.items.map((item, index) => {
            let availabilityStatus = '';
            let itemClasses = '';
            if (req.status.startsWith('processing')) {
                if (item.available === true) availabilityStatus = '<span class="text-green-600 font-bold ml-2">✓ OK</span>';
                else if (item.available === false) {
                    availabilityStatus = '<span class="text-red-600 font-bold ml-2">✗ Falta</span>';
                    itemClasses = 'text-red-700 line-through';
                }
            }
            let itemButtons = '';
            if (role === 'admin' && (req.status === 'pending' || req.status.startsWith('processing'))) {
                itemButtons = `
                    <button data-request-id="${req.id}" data-item-index="${index}" data-available="true" class="mark-item-btn text-green-600 hover:text-green-800 text-xs ml-2 p-1 border border-green-300 rounded">OK</button>
                    <button data-request-id="${req.id}" data-item-index="${index}" data-available="false" class="mark-item-btn text-red-600 hover:text-red-800 text-xs ml-1 p-1 border border-red-300 rounded">Falta</button>
                `;
            }
            return `<li class="${itemClasses} flex justify-between items-center"><span>${item.productName} (x${item.quantity})</span> <div>${availabilityStatus}${itemButtons}</div></li>`;
        }).join('');
        let adminActionsHtml = '';
        if (role === 'admin' && req.status !== 'completed' && req.status !== 'cancelled') {
            let buttons = '';
            if (req.status === 'pending') buttons += `<button data-request-id="${req.id}" data-action="start_processing" class="action-btn bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-2 rounded mr-1">Iniciar Revisión</button>`;
            if (req.status.startsWith('processing')) {
                 buttons += `<button data-request-id="${req.id}" data-action="completed" class="action-btn bg-teal-500 hover:bg-teal-600 text-white text-xs py-1 px-2 rounded">Marcar Realizado</button>`;
                 buttons += `<button data-request-id="${req.id}" data-action="revert_to_pending" class="action-btn bg-gray-400 hover:bg-gray-500 text-white text-xs py-1 px-2 rounded ml-1">Revertir</button>`;
            }
            buttons += `<button data-request-id="${req.id}" data-action="cancel" class="action-btn bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-2 rounded ml-1">Cancelar</button>`;
            adminActionsHtml = `<div class="mt-3">${buttons}</div>`;
        }
        let requesterActionsHtml = '';
        if (role === 'requester' && req.status === 'pending') {
             requesterActionsHtml = `<button data-request-id="${req.id}" class="delete-my-request-btn bg-red-500 hover:bg-red-700 text-white text-xs py-1 px-2 rounded">Eliminar</button>`;
        }
        card.innerHTML = `
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-semibold text-md">ID: ${req.id.substring(0, 8)}</h4>
                    <p class="text-sm">De: ${req.fromWarehouse} → A: <strong>${req.toWarehouse}</strong></p>
                    <p class="text-sm">Solicitante: ${req.requesterName}</p>
                    <p class="text-sm">Estado: <span class="font-medium">${translateStatus(req.status)}</span></p>
                    ${req.notes ? `<p class="text-sm text-orange-600 mt-1"><em>Notas Admin: ${req.notes}</em></p>` : ''}
                </div>
                ${requesterActionsHtml}
            </div>
            <p class="text-sm mt-2 font-medium">Items:</p>
            <ul class="list-disc list-inside text-sm ml-4 space-y-1 mt-1">${itemsHtml}</ul>
            ${adminActionsHtml}
        `;
        card.querySelectorAll('.action-btn').forEach(b => b.onclick = handleAdminAction);
        card.querySelectorAll('.mark-item-btn').forEach(b => b.onclick = handleMarkItemAvailability);
        card.querySelectorAll('.delete-my-request-btn').forEach(b => b.onclick = handleDeleteMyRequest);
        return card;
    }

    function handleAddToTransfer(event) {
        const button = event.currentTarget;
        const product = allProducts.find(p => p.id === button.dataset.productId);
        if (!product) return;
        const qtyInput = document.getElementById(`qty-${product.id.replace(/[^a-zA-Z0-9-_]/g, '')}`);
        const quantity = parseInt(qtyInput.value, 10);
        const existingItem = currentTransferItems.find(i => i.productId === product.id);
        if (existingItem) existingItem.quantity += quantity;
        else currentTransferItems.push({ productId: product.id, productName: product.name, quantity });
        qtyInput.value = "1";
        localStorage.setItem('currentTransferDraft', JSON.stringify(currentTransferItems));
        renderCurrentTransfer();
    }
    
    function handleUpdateItemQuantity(event) {
        const input = event.currentTarget;
        const itemIndex = parseInt(input.dataset.itemIndex, 10);
        const newQuantity = parseInt(input.value, 10);
        if(isNaN(newQuantity) || newQuantity < 1) {
            input.value = currentTransferItems[itemIndex].quantity;
            return;
        }
        currentTransferItems[itemIndex].quantity = newQuantity;
        localStorage.setItem('currentTransferDraft', JSON.stringify(currentTransferItems));
    }

    function handleRemoveItem(event) {
        const itemIndex = parseInt(event.currentTarget.dataset.itemIndex, 10);
        currentTransferItems.splice(itemIndex, 1);
        localStorage.setItem('currentTransferDraft', JSON.stringify(currentTransferItems));
        renderCurrentTransfer();
    }
    
    async function handleSubmitTransferForm(event) {
        event.preventDefault();
        if (currentTransferItems.length === 0) {
            alert("Agrega productos antes de enviar.");
            return;
        }
        const newReq = {
            items: currentTransferItems,
            fromWarehouse: fromWarehouseSelect.value,
            toWarehouse: toWarehouseSelect.value,
            requesterName: requesterNameSelect.value,
            status: 'pending',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        try {
            await transfersCollection.add(newReq);
            currentTransferItems = [];
            localStorage.removeItem('currentTransferDraft');
            renderCurrentTransfer();
            alert("¡Solicitud enviada a la nube con éxito!");
        } catch (error) {
            console.error("Error al guardar en Firebase: ", error);
            alert("Error al enviar la solicitud. Revisa la consola (F12).");
        }
    }

    async function handleDeleteMyRequest(event) {
        const requestId = event.currentTarget.dataset.requestId;
        if (confirm("¿Eliminar esta solicitud de la nube?")) {
            try {
                await transfersCollection.doc(requestId).delete();
            } catch (error) {
                console.error("Error al eliminar: ", error);
            }
        }
    }

    async function handleAdminAction(event) {
        const { requestId, action } = event.currentTarget.dataset;
        const reqRef = transfersCollection.doc(requestId);
        
        try {
            const doc = await reqRef.get();
            if (!doc.exists) return;
            const currentData = doc.data();
            const currentNotes = currentData.notes || "";
            let updateData = {};

            switch(action) {
                case 'start_processing':
                    updateData = { status: 'processing_partial_items', notes: 'Revisión iniciada.' };
                    break;
                case 'completed':
                    if (currentData.items.some(item => item.available === false) && !confirm("Hay ítems faltantes. ¿Completar igual?")) return;
                    updateData = { status: 'completed', notes: currentNotes + " Traslado completado." };
                    break;
                case 'revert_to_pending':
                    if (confirm("¿Revertir a Pendiente?")) {
                        const resetItems = currentData.items.map(i => ({...i, available: null}));
                        updateData = { status: 'pending', notes: 'Revertido a pendiente.', items: resetItems };
                    } else return;
                    break;
                case 'cancel':
                    if (confirm("¿Cancelar esta solicitud?")) {
                        updateData = { status: 'cancelled', notes: currentNotes + " Solicitud cancelada." };
                    } else return;
                    break;
            }
            await reqRef.update(updateData);
        } catch(e) { console.error("Error al actualizar la solicitud:", e); }
    }
    
    async function handleMarkItemAvailability(event) {
        const { requestId, itemIndex, available } = event.currentTarget.dataset;
        const reqRef = transfersCollection.doc(requestId);
        
        try {
            const doc = await reqRef.get();
            if (doc.exists) {
                let reqData = doc.data();
                reqData.items[itemIndex].available = (available === 'true');
                if(reqData.status === 'pending') {
                    reqData.status = 'processing_partial_items';
                }
                await reqRef.update({ items: reqData.items, status: reqData.status });
            }
        } catch(e) { console.error("Error al marcar el ítem:", e); }
    }
    
    function handleSearchInput() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const filtered = allProducts.filter(p => p.name.toLowerCase().includes(searchTerm) || p.description.toLowerCase().includes(searchTerm) || p.id.toLowerCase().includes(searchTerm));
        renderProducts(filtered);
    }
    
    function getRequestStatusColor(s) { return {'pending':'bg-yellow-50 border-yellow-400','processing_all_items':'bg-blue-50 border-blue-400','processing_partial_items':'bg-orange-50 border-orange-400','completed':'bg-green-100 border-green-500','cancelled':'bg-red-100 border-red-400'}[s]||'bg-gray-50 border-gray-300'; }
    function translateStatus(s) { return {'pending':'Pendiente','processing_all_items':'En Revisión (Todo OK)','processing_partial_items':'En Revisión (Parcial)','completed':'Realizado','cancelled':'Cancelado'}[s]||s; }

    function loadAndTransformProducts() {
        const rawData = [
            // ================= ¡IMPORTANTE! PEGA AQUÍ TUS PRODUCTOS =================
            // Recuerda que cada línea de producto {...}, debe terminar con una coma (,)
            // excepto la última línea de la lista.
            { "738678000984 - DAILY CLEANS SHAMPOO AMERICAN CREW X 250ML": "669316222034 - BALSAMO AMERICAN CREW 170 ML" },
            { "738678000984 - DAILY CLEANS SHAMPOO AMERICAN CREW X 250ML": "669316408063 - FIBER CREAM AMERICAN CREW 100ML" },
            { "738678000984 - DAILY CLEANS SHAMPOO AMERICAN CREW X 250ML": "738678002674 - CERA AMERICAN CREW DEFINING PASTE 85G ROJO" }
            // LA ÚLTIMA LÍNEA NO LLEVA COMA
            // =======================================================================
        ];

        if (!rawData || rawData.length === 0) {
            productListDiv.innerHTML = '<p class="text-red-500 col-span-full text-center">Error: Agrega tus productos en el código.</p>';
            return [];
        }
        const uniqueProductStrings = new Set();
        rawData.forEach(item => {
            Object.keys(item).forEach(key => uniqueProductStrings.add(key));
            Object.values(item).forEach(val => val && uniqueProductStrings.add(val));
        });
        const productsMap = new Map();
        let genericCounter = 1;
        Array.from(uniqueProductStrings).forEach(fullProductName => {
            const parts = String(fullProductName).split(' - ');
            let idPart, namePart;
            if (parts.length > 1 && (/\d/.test(parts[0].trim()) || /^[a-zA-Z]{2,}/.test(parts[0].trim()))) {
                idPart = parts[0].trim().replace(/\s+/g, '-');
                namePart = parts.slice(1).join(' - ').trim();
            } else {
                idPart = `prod-gen-${genericCounter++}`;
                namePart = fullProductName;
            }
            let finalId = idPart;
            let idCounter = 1;
            while (productsMap.has(finalId)) finalId = `${idPart}_${idCounter++}`;
            productsMap.set(finalId, { id: finalId, name: namePart, description: fullProductName });
        });
        return Array.from(productsMap.values()).sort((a, b) => a.name.localeCompare(b.name));
    }

    function initializeApp() {
        allProducts = loadAndTransformProducts();
        displayInitialProducts();
        renderCurrentTransfer();

        roleSelector.onchange = handleRoleChange;
        requesterNameSelect.onchange = renderAllSections;
        transferForm.onsubmit = handleSubmitTransferForm;
        searchInput.oninput = handleSearchInput;
        
        transfersCollection.orderBy("timestamp", "desc").onSnapshot(snapshot => {
            console.log("Datos recibidos de Firebase!");
            allTransferRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAllSections();
        }, error => {
            console.error("Error al conectar con Firebase: ", error);
            alert("No se pudo conectar a la base de datos. Revisa la consola (F12).")
        });

        updateUserRoleView();
    }

    initializeApp();
});
</script>

</body>
</html>
